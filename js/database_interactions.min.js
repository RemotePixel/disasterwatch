var disasterwatchAPI="https://tcuraimo51.execute-api.us-east-1.amazonaws.com/test/";function getDisasterdb(a){$("#disasters-panel .spin2").removeClass("display-none");$(".list-disasters").scrollTop(0);$(".list-disasters").empty();$.get(disasterwatchAPI+"toGEOJSON").fail(function(){if(typeof a==="function"){return a("Could not retrieve the database")}}).success(function(c){map.getSource("disasterdb").setData(c);for(var b=0;b<c.features.length;b++){var d=(c.features[b].properties.dtype.length!==0)?c.features[b].properties.dtype[0]:"unclassified";$(".list-disasters").append('<div class="list-element" dw-type="'+d+'" date-start="'+c.features[b].properties.dateStart+'" date-end="'+c.features[b].properties.dateEnd+'" target="_blank" onclick="mapFlyToDisaster(\''+c.features[b].properties.uuid+'\')"><div class="col"><div class="disaster-descr"><div class="icon icon-'+d+'" title="'+d+'"></div></div><div class="disaster-descr"><span class="dtitle">'+c.features[b].properties.name+'</span><span class="dplace">'+c.features[b].properties.place+"</span></div></div></div>")}filterListDisaster();$("#disasters-panel .spin2").addClass("display-none");if(typeof a==="function"){return a(null,"ready")}})}function addDisastTodb(){var c=draw.getAll(),b=c.features[0];if(b.geometry.type==="Polygon"){if(turf.area(b)>=100000000000){$("#modalPolySize").modal();return}}$('.disaster-info button[type="submit"]').attr("disabled",true);$(".map .spin").removeClass("display-none");delete b.id;b.properties.uuid=generateUUID();if(document.getElementById("mailCheckbox").checked){var a=$.map($(".disaster-info .sat-filter input:checked"),function(d){return d.getAttribute("data")});b.properties.mail={mail:document.getElementById("disastermailTo").value,satellite:a}}else{b.properties.mail=null}b.properties.dtype=$('#disasterType span[type="dtype"]').map(function(){return this.className}).toArray();b.properties.name=document.getElementById("disasterName").value;b.properties.place=document.getElementById("disasterPlace").value;b.properties.dateStart=document.getElementById("disasterStartDate").value;b.properties.dateEnd=(document.getElementById("dateCheckbox").checked)?"":document.getElementById("disasterEndDate").value;b.properties.comments=document.getElementById("disasterComments").value.replace(/\n\r?/g,"<br />");b.properties.images={landsat8:($('.img-preview [sat="landsat8"]').first().attr("img-date"))?$('.img-preview [sat="landsat8"]').first().attr("img-date"):moment.utc().subtract(15,"days").format("YYYY-MM-DD"),sentinel2:($('.img-preview [sat="sentinel2"]').first().attr("img-date"))?$('.img-preview [sat="sentinel2"]').first().attr("img-date"):moment.utc().subtract(15,"days").format("YYYY-MM-DD"),sentinel1:($('.img-preview [sat="sentinel1"]').first().attr("img-date"))?$('.img-preview [sat="sentinel1"]').first().attr("img-date"):moment.utc().subtract(15,"days").format("YYYY-MM-DD"),};$.ajax({url:disasterwatchAPI+"add",type:"POST",data:JSON.stringify(b),dataType:"json",contentType:"application/json",}).success(function(d){getDisasterdb(function(f,e){if(f){$("#modalDBerror").modal();console.log("Could not retrieve updated database")}closeleftblock();$(".map .spin").addClass("display-none")})}).fail(function(){$(".disaster-info .error").addClass("on");$('.disaster-info button[type="submit"]').attr("disabled",false);$(".map .spin").addClass("display-none");console.log("Could not add Disaster Event to database")})}function updateDisastTodb(){var c=draw.getAll(),b=c.features[0];if(b.geometry.type==="Polygon"){if(turf.area(b)>=100000000000){$("#modalPolySize").modal();return}}$('.disaster-info button[type="submit"]').attr("disabled",true);$(".map .spin").removeClass("display-none");delete b.id;if(document.getElementById("mailCheckbox").checked){var a=$.map($(".disaster-info .sat-filter input:checked"),function(d){return d.getAttribute("data")});b.properties.mail={mail:document.getElementById("disastermailTo").value,satellite:a}}else{b.properties.mail=null}delete b.properties.nbfollowers;b.properties.dtype=$('#disasterType span[type="dtype"]').map(function(){return this.className}).toArray();b.properties.name=document.getElementById("disasterName").value;b.properties.place=document.getElementById("disasterPlace").value;b.properties.dateStart=document.getElementById("disasterStartDate").value;b.properties.dateEnd=(document.getElementById("dateCheckbox").checked)?"":document.getElementById("disasterEndDate").value;b.properties.comments=document.getElementById("disasterComments").value.replace(/\n\r?/g,"<br />");$.ajax({url:disasterwatchAPI+"update",type:"POST",data:JSON.stringify(b),dataType:"json",contentType:"application/json",}).success(function(d){getDisasterdb(function(f,e){if(f){$("#modalDBerror").modal();console.log("Could not retrieve updated database")}closeleftblock();$(".map .spin").addClass("display-none")})}).fail(function(){$(".disaster-info .error").addClass("on");$('.disaster-info button[type="submit"]').attr("disabled",false);$(".map .spin").addClass("display-none");console.log("Could not update Disaster Event to database")})}function subscribeEvt(e){$(".map .spin").removeClass("display-none");var f=$(e).parent(),c=f.attr("data-uuid");var b=$.map($(f).find(".sat-filter input:checked"),function(g){return g.getAttribute("data")});var a={mail:$(f).find('input[type="email"]').val(),satellite:b},d={uuid:c,mail:a};$.ajax({url:disasterwatchAPI+"subscribe",type:"POST",data:JSON.stringify(d),dataType:"json",contentType:"application/json",}).success(function(g){closePopup();getDisasterdb(function(i,h){if(i){$("#modalDBerror").modal();console.log("Could not retrieve updated database")}$(".map .spin").addClass("display-none")})}).fail(function(){$(".map .spin").addClass("display-none");$(".mapboxgl-popup-content .subscribe-section .error").addClass("on");console.log("Could not update Disaster Event to database")})}function removeEvt(a){$(".map .spin").removeClass("display-none");$.ajax({url:disasterwatchAPI+"remove",type:"POST",data:JSON.stringify({uuid:a}),dataType:"json",contentType:"application/json",}).success(function(b){getDisasterdb(function(d,c){if(d){$("#modalDBerror").modal();console.log("Could not retrieve updated database")}closePopup();$(".map .spin").addClass("display-none")})}).fail(function(){$(".mapboxgl-popup-content .db-error").addClass("on");console.log("Could not remove Disaster Event to database")})}function seeEvtDBimages(e){var b=map.getSource("disasterdb")._data.features.filter(function(f){return(f.properties.uuid===e)});if(b.length===0){$("#modalError").modal()}else{draw.deleteAll();openleftBlock();$(".tab-selector-1").addClass("out");$(".tab-selector-2").addClass("out");if(draw.getMode()!=="static"){draw.changeMode("static")}var d=draw.add(b[0]),b=draw.getAll();if(b.features[0].geometry.type==="LineString"){var c=turf.extent(b.features[0].geometry);map.fitBounds(c,{padding:20})}if(b.features[0].geometry.type==="Point"){var a=turf.buffer(b.features[0],100,"kilometers"),c=turf.extent(a);map.fitBounds(c,{padding:20})}getImages();closePopup()}}function editEvt(e){var b=map.getSource("disasterdb")._data.features.filter(function(f){return(f.properties.uuid===e)});if(b.length===0){$("#modalError").modal()}else{resetForm();openleftBlock();draw.deleteAll();if(draw.getMode()!=="simple_select"){draw.changeMode("simple_select")}$(".tab-selector-2").prop("checked",true);$(".tab-selector-1").addClass("out");$(".tab-selector-2").addClass("out");var d=draw.add(b[0]);if(b[0].geometry.type==="LineString"){var c=turf.extent(b[0].geometry);map.fitBounds(c,{padding:20})}if(b[0].geometry.type==="Point"){var a=turf.buffer(b[0],100,"kilometers"),c=turf.extent(a);map.fitBounds(c,{padding:20})}document.getElementById("uuid").textContent="UUID: "+e;b[0].properties.dtype.forEach(function(f){addType(document.getElementById("dropdown-menu").getElementsByClassName(f)[0].parentElement)});document.getElementById("disasterName").value=b[0].properties.name;document.getElementById("disasterPlace").value=b[0].properties.place;$("#disasterStartDate").datepicker("setDate",b[0].properties.dateStart);if(b[0].properties.dateEnd===""){$("#dateCheckbox").prop("checked",true).change()}else{$("#disasterEndDate").datepicker("setDate",b[0].properties.dateEnd)}document.getElementById("disasterComments").value=b[0].properties.comments.replace(/<br\s?\/?>/g,"\n");closePopup()}};