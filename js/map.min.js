mapboxgl.accessToken="pk.eyJ1IjoidmluY2VudHNhcmFnbyIsImEiOiJjaWlleG1vdmowMWhydGtrc2xqcmQzNmhlIn0.80HAFLCQ6yUWCk4mwm6zbw";var map=new mapboxgl.Map({container:"map",center:[0,10],zoom:1,style:"mapbox://styles/vincentsarago/ciuknp8en007g2io2qc4bbh7x",attributionControl:true,minZoom:0,maxZoom:8}),draw=mapboxgl.Draw({displayControlsDefault:false});map.dragRotate.disable();map.touchZoomRotate.disableRotation();var geocoder=new mapboxgl.Geocoder({container:"geocoder-container"});map.addControl(geocoder);map.addControl(draw);map.addControl(new mapboxgl.Navigation());var btnsearch=document.createElement("button");btnsearch.className="mapboxgl-ctrl-icon";btnsearch.setAttribute("onclick","toggleSearch()");var icnsearch=document.createElement("i");icnsearch.className="fa fa-search ";btnsearch.appendChild(icnsearch);var grp=document.createElement("div");grp.className="mapboxgl-ctrl-group mapboxgl-ctrl";grp.appendChild(btnsearch);var control=document.getElementsByClassName("mapboxgl-ctrl-top-right");control[0].appendChild(grp.cloneNode(true));map.on("style.load",function(){map.addSource("landsat",{type:"vector",url:"mapbox://vincentsarago.8ib6ynrs"});map.addLayer({id:"l8-highlighted",type:"fill",source:"landsat","source-layer":"Landsat8_Desc_filtr2",paint:{"fill-outline-color":"#1386af","fill-color":"#0f6d8e","fill-opacity":0.3},filter:["in","PATH",""]});map.addSource("sentinel2",{type:"vector",url:"mapbox://vincentsarago.0qowxm38"});map.addLayer({id:"s2-highlighted",type:"fill",source:"sentinel2","source-layer":"Sentinel2_Grid",paint:{"fill-outline-color":"#1386af","fill-color":"#0f6d8e","fill-opacity":0.3},filter:["in","Name",""]});var a={type:"FeatureCollection",features:[]};map.addSource("sentinel-1",{type:"geojson",data:a});map.addLayer({id:"s1-highlighted",type:"fill",source:"sentinel-1",paint:{"fill-outline-color":"#1386af","fill-color":"#0f6d8e","fill-opacity":0.3},filter:["==","id",""]});var a={type:"FeatureCollection",features:[]};map.addSource("disasterdb",{type:"geojson",data:a});map.addLayer({id:"disasterdb-points",type:"circle",source:"disasterdb",filter:["all",["==","$type","Point"],["!=","dateEnd",""]],paint:{"circle-color":"#3293ed","circle-radius":{base:4,stops:[[0,4],[9,10]]}}});map.addLayer({id:"disasterdb-polygons",type:"fill",source:"disasterdb",filter:["all",["==","$type","Polygon"],["!=","dateEnd",""]],paint:{"fill-outline-color":"#3293ed","fill-color":"#454545","fill-opacity":{base:1,stops:[[0,1],[9,0.4]]}}});map.addLayer({id:"disasterdb-points-ongoing",type:"circle",source:"disasterdb",filter:["all",["==","$type","Point"],["==","dateEnd",""]],paint:{"circle-color":"#da7979","circle-radius":{base:4,stops:[[0,4],[9,10]]}}});map.addLayer({id:"disasterdb-polygons-ongoing",type:"fill",source:"disasterdb",filter:["all",["==","$type","Polygon"],["==","dateEnd",""]],paint:{"fill-outline-color":"#da7979","fill-color":"#ba3e3e","fill-opacity":{base:1,stops:[[0,1],[9,0.4]]}}});map.addSource("earthquakes",{type:"geojson",data:a});map.addLayer({id:"earthquakes-blur",type:"circle",source:"earthquakes",maxzoom:9,layout:{visibility:"none"},paint:{"circle-opacity":0.8,"circle-radius":{property:"mag",base:1.8,stops:[[{zoom:0,value:2},0.25],[{zoom:0,value:8},16],[{zoom:9,value:2},10],[{zoom:9,value:8},100]]},"circle-color":{property:"mag",stops:[["4.5","#fff"],["8","#f00"]]}}});map.addLayer({id:"earthquakes-point",type:"circle",source:"earthquakes",layout:{visibility:"none"},paint:{"circle-color":"rgb(23, 14, 3)","circle-radius":{base:1.1,stops:[[0,0.5],[8,3]]}}});map.addSource("eonet",{type:"geojson",data:a});map.addLayer({id:"eonet-point",type:"symbol",source:"eonet",layout:{visibility:"none","icon-image":"{icon}-15"}});map.on("mousemove",function(f){var g=1,d=map.queryRenderedFeatures([[f.point.x-g,f.point.y-g],[f.point.x+g,f.point.y+g]],{layers:["eonet-point","earthquakes-point","disasterdb-points","disasterdb-polygons","disasterdb-points-ongoing","disasterdb-polygons-ongoing"]})[0];if(d){map.getCanvas().style.cursor="pointer"}else{map.getCanvas().style.cursor="inherit"}}).on("click",function(m){var l=1;if(map.getLayer("earthquakes-point").getLayoutProperty("visibility")!=="none"){var p=map.queryRenderedFeatures([[m.point.x-l,m.point.y-l],[m.point.x+l,m.point.y+l]],{layers:["earthquakes-point"]})[0];if(p){var f=new mapboxgl.Popup().setLngLat(m.lngLat).setHTML('<div class="dtypeImage"><div class="icon icon-earthquake" title="earthquake"></div></div><div class="linetab bold">Name: '+p.properties.title+'</div><div class="linetab">Date: '+moment(p.properties.time).utc().format("YYYY-MM-DD HH:mm:ss")+'(UTC)</div><div class="linetab">Magnitude: '+p.properties.mag+'</div><div class="linetab">Felt: '+((p.properties.felt===null)?"No":"Yes")+'</div><div class="linetab">Duration (min): '+p.properties.dmin+'</div><div class="linetab">Tsunami: '+((p.properties.tsunami===0)?"No":"Yes")+'</div><div class="linetab"><a target="_blank" href="'+p.properties.url+'">Info</a></div><div class="linetab"><a class="link" onclick="seeEQimages(\''+p.properties.detail+"')\">Search Images</a></div>").addTo(map)}}if(map.getLayer("eonet-point").getLayoutProperty("visibility")!=="none"){var p=map.queryRenderedFeatures([[m.point.x-l,m.point.y-l],[m.point.x+l,m.point.y+l]],{layers:["eonet-point"]})[0];if(p){var o="",d=JSON.parse(p.properties.sources);for(var g=0;g<d.length;g++){o+='<a target="_blank" href="'+d[g].url+'">'+d[g].id+"</a> "}var f=new mapboxgl.Popup().setLngLat(m.lngLat).setHTML('<div class="linetab bold">Name: '+p.properties.title+'</div><div class="linetab">Date: '+moment(p.properties.date).format("YYYY-MM-DD HH:mm:ss")+'(UTC)</div><div class="linetab">Type: '+p.properties.dtype+'</div><div class="linetab">Description: '+p.properties.description+'</div><div class="linetab">Links: '+o+"</div>").addTo(map)}}var p=map.queryRenderedFeatures([[m.point.x-l,m.point.y-l],[m.point.x+l,m.point.y+l]],{layers:["disasterdb-points","disasterdb-polygons","disasterdb-points-ongoing","disasterdb-polygons-ongoing"]})[0];if(p){var q="",k=JSON.parse(p.properties.dtype),n;for(var g=0;g<k.length;g++){q+='<span type="dtype" class="'+k[g]+'">'+k[g]+"</span> "}if(k.length===0){q='<span type="dtype" class="unclassified">unclassified</span>';n="unclassified"}else{n=k[0]}var i=p.properties.comments.split("<br />").map(function(j){return textTolink(j)});var h="";for(var g=0;g<i.length;g++){h+=i[g]}var f=new mapboxgl.Popup().setLngLat(m.lngLat).setHTML('<div class="dtypeImage"><div class="icon icon-'+n+'" title="'+n+'"></div></div><div class="linetab bold">Name: '+p.properties.name+'</div><div class="linetab uuid">uuid: '+p.properties.uuid+'</div><div class="linetab disasterType">Type: '+q+'</div><div class="linetab">Location: '+p.properties.place+'</div><div class="linetab">Start Date: '+p.properties.dateStart+'</div><div class="linetab">End Date: '+p.properties.dateEnd+'</div><div class="linetab">Followers: '+p.properties.nbfollowers+'</div><div class="linetab">Comments:</div><div class="linetab comments">'+h+'</div><div class="delim"></div><div class="linetab"><a onclick="seeEvtDBimages(\''+p.properties.uuid+'\')">Search Images</a></div><div class="linetab"><a onclick="editEvt(\''+p.properties.uuid+"')\">Update</a> | <a onclick=\"removeEvt('"+p.properties.uuid+'\')">Remove</a> | <a onclick="toggleSubscribe()">Subscribe</a></div><span class="db-error red">Error...Cannot remove this event from database</span><div data-uuid="'+p.properties.uuid+'" class="subscribe-section display-none"><div class="delim"></div><div class="sat-filter"><label><input data="landsat8" type="checkbox" checked> Landsat-8</label><label><input data="sentinel2" type="checkbox" checked> Sentinel-2</label><label><input data="sentinel1" type="checkbox" checked> Sentinel-1</label></div><input type="email" class="form-control" placeholder="Email"><div class="btn btn-default" onclick="subscribeEvt(this)">Subscribe</div><span class="error red">Error...</span></div>').addTo(map)}});var b=document.getElementById("slider"),c=document.getElementById("slider-value");b.addEventListener("input",function(d){if(map.getSource("gibs-tiles")){map.setPaintProperty("gibs-tiles","raster-opacity",parseInt(d.target.value,10)/100)}c.textContent=d.target.value+"%"});getDisasterdb(function(f,d){if(f){$("#modalDBerror").modal();console.log("Could not retrieve updated database");return}var e=getUrlVars();if(e.hasOwnProperty("update")){editEvt(e.update);$(".dwhelp-block").removeClass("on")}else{if(e.hasOwnProperty("images")){$(".dwhelp-block").removeClass("on");seeEvtDBimages(e.images)}}});getEarthquake();getEONETEvents()});map.on("draw.selectionchange",function(a){if(!$(".leftblock").hasClass("in")){if(a.features.length!==0){$("#modalQuestion").modal()}}});map.on("draw.update",function(b){if(b.features[0].geometry.type==="Polygon"){if(turf.area(b.features[0])>=100000000000){$("#modalPolySize").modal();return}}if(!b.features[0].properties.hasOwnProperty("uuid")){getImages();if(b.features[0].geometry.type==="Polygon"){var a=turf.centroid(b.features[0]);getPlace(a.geometry.coordinates)}if(b.features[0].geometry.type==="Point"){getPlace(b.features[0].geometry.coordinates)}}});map.on("draw.create",function(c){if(c.features[0].geometry.type==="Polygon"){if(turf.area(c.features[0])>=100000000000){$("#modalPolySize").modal();draw.deleteAll();return}}openleftBlock();getImages();if(c.features[0].geometry.type==="Polygon"){var d=turf.extent(c.features[0].geometry);var b=turf.centroid(c.features[0]);getPlace(b.geometry.coordinates);map.fitBounds(d,{padding:20})}if(c.features[0].geometry.type==="Point"){var a=turf.buffer(c.features[0],100,"kilometers"),d=turf.extent(a);getPlace(c.features[0].geometry.coordinates);map.fitBounds(d,{padding:20})}});geocoder.on("result",function(b){$(".geocoder-container").toggleClass("in");var a={geometry:b.result.geometry,properties:{},type:"Feature"};var c=draw.add(a);document.getElementById("disasterPlace").value=b.result.place_name;openleftBlock();getImages()});function setStyle(d){if(map.getSource("gibs-tiles")){map.removeLayer("gibs-tiles");map.removeSource("gibs-tiles")}switch(d){case"MapboxMap":$(".date-button").attr("disabled","disabled");$("#slider").attr("disabled","disabled");$(".bottom-right-control").addClass("display-none");$(".bottom-right-control").removeClass("on");return;default:if($(".bottom-right-control").hasClass("display-none")){$(".bottom-right-control").removeClass("display-none");$(".bottom-right-control").addClass("on")}$(".date-button").attr("disabled",false);$("#slider").attr("disabled",false);var b=document.getElementsByClassName("date-button")[0].textContent,c="https://map1.vis.earthdata.nasa.gov/wmts-webmerc/"+d+"/default/"+b+"/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpg";map.addSource("gibs-tiles",{type:"raster",tiles:[c],attribution:['<a href="https://earthdata.nasa.gov/about/science-system-description/eosdis-components/global-imagery-browse-services-gibs"> NASA EOSDIS GIBS</a>'],tileSize:256});var a=document.getElementById("slider").value/100;map.addLayer({id:"gibs-tiles",type:"raster",source:"gibs-tiles",minzoom:1,maxzoom:9,paint:{"raster-opacity":a}},"admin-2-boundaries-bg")}}function changeOverlay(a){$("#basemaps-panel .side-view-content .side-element .link-on").each(function(){$(this).removeClass("on")});$("#"+a+" .link-on").addClass("on");setStyle(a)}function update_basemaps(){var a=document.getElementsByClassName("link-on on")[0].parentElement.getAttribute("id");setStyle(a)}function drawOnMap(a){draw.deleteAll();if(draw.getMode()!=="simple_select"){draw.changeMode("simple_select")}switch(a){case"point":draw.changeMode("draw_point");break;case"polygon":draw.changeMode("draw_polygon");break;case null:break}}function mapFlyToDisaster(d){var b=map.getSource("disasterdb")._data.features.filter(function(f){return(f.properties.uuid===d)});if(b){if(b[0].geometry.type==="Polygon"){var c=turf.extent(b[0].geometry);map.fitBounds(c,{padding:20})}if(b[0].geometry.type==="Point"){var a=turf.buffer(b[0],100,"kilometers"),c=turf.extent(a);map.fitBounds(c,{padding:20})}}}function hoverS1(a){map.setFilter("s1-highlighted",a)}function hoverS2(a){map.setFilter("s2-highlighted",a)}function hoverL8(a){map.setFilter("l8-highlighted",a)}$("#volcanoes-checkbox").change(function(){$("#volcanoes-checkbox").parent().toggleClass("green");if(document.getElementById("volcanoes-checkbox").checked){map.setLayoutProperty("volcanoes","visibility","visible")}else{map.setLayoutProperty("volcanoes","visibility","none")}});$("#earthquake-checkbox").change(function(){$("#earthquake-checkbox").parent().toggleClass("green");if(document.getElementById("earthquake-checkbox").checked){map.setLayoutProperty("earthquakes-point","visibility","visible");map.setLayoutProperty("earthquakes-blur","visibility","visible")}else{map.setLayoutProperty("earthquakes-point","visibility","none");map.setLayoutProperty("earthquakes-blur","visibility","none")}});$("#eonet-checkbox").change(function(){$("#eonet-checkbox").parent().toggleClass("green");if(document.getElementById("eonet-checkbox").checked){map.setLayoutProperty("eonet-point","visibility","visible")}else{map.setLayoutProperty("eonet-point","visibility","none")}});